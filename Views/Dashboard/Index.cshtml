@{
    ViewData["Title"] = "Dashboard";
    Layout = "_Layout";
}

<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-left">
            <h1 class="dashboard-title">📊 Planner Dashboard</h1>
            <p class="dashboard-subtitle">Welcome back, @ViewBag.UserName! Here's what's happening.</p>
        </div>
        <div class="header-right">
            <div class="date-time">
                <span id="currentDate"></span>
                <span id="currentTime"></span>
            </div>
            <button class="btn-refresh" onclick="refreshDashboard()">
                <i class="refresh-icon">🔄</i> Refresh
            </button>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats">
        <div class="stat-card stat-total-tasks" data-animation="pulse">
            <div class="stat-icon">📋</div>
            <div class="stat-content">
                <div class="stat-value" id="totalTasks">@ViewBag.Stats.TotalTasks</div>
                <div class="stat-label">Total Tasks</div>
                <div class="stat-trend">
                    <span class="trend-up">↑ @ViewBag.Stats.TasksThisWeek this week</span>
                </div>
            </div>
        </div>

        <div class="stat-card stat-active-tasks" data-animation="slide">
            <div class="stat-icon">⚡</div>
            <div class="stat-content">
                <div class="stat-value" id="activeTasks">@ViewBag.Stats.ActiveTasks</div>
                <div class="stat-label">Active Tasks</div>
                <div class="stat-trend">
                    <span class="trend-neutral">In progress</span>
                </div>
            </div>
        </div>

        <div class="stat-card stat-resources" data-animation="slide">
            <div class="stat-icon">👥</div>
            <div class="stat-content">
                <div class="stat-value" id="totalResources">@ViewBag.Stats.TotalResources</div>
                <div class="stat-label">Resources</div>
                <div class="stat-trend">
                    <span class="trend-up">@ViewBag.Stats.ActiveResources active</span>
                </div>
            </div>
        </div>

        <div class="stat-card stat-productivity" data-animation="pulse">
            <div class="stat-icon">📈</div>
            <div class="stat-content">
                <div class="stat-value" id="productivityScore">@ViewBag.Stats.ProductivityScore.ToString("0.0")%</div>
                <div class="stat-label">Productivity</div>
                <div class="stat-trend">
                    <span class="trend-up">↑ @ViewBag.Stats.ResourcesUtilization.ToString("0.0")% utilization</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="main-tabs">
        <div class="tabs-header">
            <button class="tab-btn active" data-tab="overview">
                <i class="tab-icon">🏠</i> Overview
            </button>
            <button class="tab-btn" data-tab="analytics">
                <i class="tab-icon">📈</i> Analytics
            </button>
            <button class="tab-btn" data-tab="tasks">
                <i class="tab-icon">✅</i> Tasks
            </button>
            <button class="tab-btn" data-tab="resources">
                <i class="tab-icon">👥</i> Resources
            </button>
            <button class="tab-btn" data-tab="schedule">
                <i class="tab-icon">📅</i> Schedule
            </button>
            <button class="tab-btn" data-tab="reports">
                <i class="tab-icon">📊</i> Reports
            </button>
        </div>

        <div class="tabs-content">
            <!-- Overview Tab -->
            <div class="tab-pane active" id="overview">
                <div class="overview-grid">
                    <div class="overview-card overview-chart">
                        <h3 class="card-title">📈 Task Completion Trend</h3>
                        <div class="chart-container">
                            <canvas id="completionChart"></canvas>
                        </div>
                    </div>

                    <div class="overview-card overview-status">
                        <h3 class="card-title">📋 Task Status</h3>
                        <div class="status-grid">
                            <div class="status-item status-not-started">
                                <div class="status-count">@ViewBag.Analytics.TaskStatusDistribution["Not Started"]</div>
                                <div class="status-label">Not Started</div>
                            </div>
                            <div class="status-item status-in-progress">
                                <div class="status-count">@ViewBag.Analytics.TaskStatusDistribution["In Progress"]</div>
                                <div class="status-label">In Progress</div>
                            </div>
                            <div class="status-item status-completed">
                                <div class="status-count">@ViewBag.Analytics.TaskStatusDistribution["Completed"]</div>
                                <div class="status-label">Completed</div>
                            </div>
                            <div class="status-item status-overdue">
                                <div class="status-count">@ViewBag.Analytics.TaskStatusDistribution["Overdue"]</div>
                                <div class="status-label">Overdue</div>
                            </div>
                        </div>
                    </div>

                    <div class="overview-card overview-activities">
                        <h3 class="card-title">🕐 Recent Activities</h3>
                        <div class="activities-list">
                            @foreach (var activity in ViewBag.RecentActivities)
                            {
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        @(activity.Type == "Task" ? "✅" : "🕐")
                                    </div>
                                    <div class="activity-content">
                                        <div class="activity-text">@activity.Description</div>
                                        <div class="activity-time">@activity.Timestamp.ToString("hh:mm tt")</div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="overview-card overview-peak-hours">
                        <h3 class="card-title">⏰ Peak Hours</h3>
                        <div class="peak-hours-chart">
                            <canvas id="peakHoursChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div class="tab-pane" id="analytics">
                @await Html.PartialAsync("_AnalyticsPartial", ViewBag.Analytics)
            </div>

            <!-- Tasks Tab -->
            <div class="tab-pane" id="tasks">
                @await Html.PartialAsync("_TasksPartial")
            </div>

            <!-- Resources Tab -->
            <div class="tab-pane" id="resources">
                @await Html.PartialAsync("_ResourcesPartial")
            </div>

            <!-- Schedule Tab -->
            <div class="tab-pane" id="schedule">
                @await Html.PartialAsync("_SchedulePartial")
            </div>

            <!-- Reports Tab -->
            <div class="tab-pane" id="reports">
                <div class="reports-grid">
                    <div class="report-card">
                        <h3 class="card-title">📋 Performance Report</h3>
                        <div class="report-content">
                            <div class="report-metric">
                                <span class="metric-label">Completion Rate:</span>
                                <span class="metric-value">@ViewBag.Analytics.TaskCompletionRate.ToString("0.0")%</span>
                            </div>
                            <div class="report-metric">
                                <span class="metric-label">Avg. Task Duration:</span>
                                <span class="metric-value">24.5 hrs</span>
                            </div>
                            <div class="report-metric">
                                <span class="metric-label">Resource Utilization:</span>
                                <span class="metric-value">@ViewBag.Stats.ResourcesUtilization.ToString("0.0")%</span>
                            </div>
                            <button class="btn-generate-report">Generate PDF Report</button>
                        </div>
                    </div>

                    <div class="report-card">
                        <h3 class="card-title">📅 Schedule Analysis</h3>
                        <div class="report-content">
                            <div class="schedule-metrics">
                                <div class="metric-circle">
                                    <div class="circle-value">@ViewBag.Stats.ActiveShifts</div>
                                    <div class="circle-label">Active Shifts</div>
                                </div>
                                <div class="metric-circle">
                                    <div class="circle-value">@ViewBag.Stats.ScheduledTasks</div>
                                    <div class="circle-label">Scheduled Tasks</div>
                                </div>
                            </div>
                            <div class="schedule-timeline">
                                <h4>Upcoming Deadlines</h4>
                                <div class="timeline-items">
                                    <!-- Timeline items will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Panel -->
    <div class="quick-actions">
        <h3 class="actions-title">⚡ Quick Actions</h3>
        <div class="actions-grid">
            <button class="action-btn btn-create-task" onclick="createNewTask()">
                <i class="action-icon">➕</i>
                <span class="action-text">Create Task</span>
            </button>
            <button class="action-btn btn-schedule-shift" onclick="scheduleShift()">
                <i class="action-icon">🕐</i>
                <span class="action-text">Schedule Shift</span>
            </button>
            <button class="action-btn btn-generate-report" onclick="generateReport()">
                <i class="action-icon">📊</i>
                <span class="action-text">Generate Report</span>
            </button>
            <button class="action-btn btn-notifications" onclick="showNotifications()">
                <i class="action-icon">🔔</i>
                <span class="action-text">Notifications</span>
                <span class="notification-badge">3</span>
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/dashboard.js"></script>
    <script src="~/js/charts.js"></script>
    <script src="~/js/animations.js"></script>

    <script>
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            initializeCharts();
            startClock();

            // Load tab content dynamically
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    loadTabContent(tabId);
                });
            });
        });

        function initializeDashboard() {
            // Update stats with animations
            updateStatsWithAnimation();

            // Initialize tooltips
            initializeTooltips();

            // Set up auto-refresh
            setInterval(refreshStats, 30000); // Every 30 seconds
        }

        function refreshDashboard() {
            // Show loading animation
            document.querySelector('.dashboard-container').classList.add('refreshing');

            fetch('/Dashboard/GetStats')
                .then(response => response.json())
                .then(stats => {
                    updateStats(stats);
                    document.querySelector('.dashboard-container').classList.remove('refreshing');

                    // Show success notification
                    showNotification('Dashboard refreshed successfully!', 'success');
                })
                .catch(error => {
                    console.error('Error refreshing dashboard:', error);
                    showNotification('Failed to refresh dashboard', 'error');
                });
        }

        function updateStats(stats) {
            // Animate stat updates
            animateStatUpdate('totalTasks', stats.totalTasks);
            animateStatUpdate('activeTasks', stats.activeTasks);
            animateStatUpdate('totalResources', stats.totalResources);
            animateStatUpdate('productivityScore', stats.productivityScore.toFixed(1) + '%');
        }

        function animateStatUpdate(elementId, newValue) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.animation = 'pulse 0.5s';
                setTimeout(() => {
                    element.textContent = newValue;
                    element.style.animation = '';
                }, 250);
            }
        }

        function loadTabContent(tabId) {
            // Show loading state
            const tabPane = document.getElementById(tabId);
            tabPane.classList.add('loading');

            // Simulate loading (in real app, this would be an API call)
            setTimeout(() => {
                tabPane.classList.remove('loading');

                // Update tab content based on tabId
                switch(tabId) {
                    case 'analytics':
                        loadAnalyticsData();
                        break;
                    case 'tasks':
                        loadTasksData();
                        break;
                    case 'resources':
                        loadResourcesData();
                        break;
                    case 'schedule':
                        loadScheduleData();
                        break;
                }
            }, 500);
        }

        function startClock() {
            function updateClock() {
                const now = new Date();
                document.getElementById('currentDate').textContent =
                    now.toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                document.getElementById('currentTime').textContent =
                    now.toLocaleTimeString('en-US', {
                        hour12: true,
                        hour: 'numeric',
                        minute: '2-digit'
                    });
            }

            updateClock();
            setInterval(updateClock, 1000);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="notification-icon">${type === 'success' ? '✅' : '❌'}</i>
                    <span>${message}</span>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">×</button>
            `;

            document.body.appendChild(notification);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
    </script>
}